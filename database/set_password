#!/usr/bin/php
<?php
	chdir(dirname($argv[0]));
	require("../libraries/banshee.php");
	require("../libraries/security.php");

	$db = new MySQLi_connection(DB_HOSTNAME, DB_DATABASE, DB_USERNAME, DB_PASSWORD);
	if ($db->connected == false) {
		exit("Internal error: database not available.\n");
	}

	if (count($argv) <= 1) {
		exit("Usage: ".$argv[0]." <username>\n");
	}
	$username = $argv[1];

	/* Check username
	 */
	$query = "select count(*) as count from users where username=%s";
	if (($result = $db->execute($query, $username)) === false) {
		exit("Error while checking username.\n");
	}
	if ($result[0]["count"] == 0) {
		exit("User ".$username." not found.\n");
	}

	/* Check if user has no passwords
	 */
	$query = "select count(*) as count from containers c, users u where c.user_id=u.id and u.username=%s";
	if (($result = $db->execute($query, $username)) === false) {
		exit("Error while checking containers.\n");
	}
	if ($result[0]["count"] > 0) {
		exit("User has stored passwords or containers.\n");
	}

	do {
		print "Enter password: ";
		system("/bin/stty -echo");
		$password = trim(fgets(STDIN));
		system("/bin/stty echo");
		print "\n";
	} while ($password == "");

	$aes = new AES256($password);
	$crypto_key = base64_encode($aes->encrypt(random_string(32)));

	$password = hash_password($password, $username);

	$query = "update users set password=%s, crypto_key=%s where username=%s";
	if ($db->query($query, $password, $crypto_key, $username) === false) {
		exit("Database error while setting password.\n");
	}
?>
